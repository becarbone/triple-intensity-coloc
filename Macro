//Redone - Bea C. 2018
//original macro by Lai Ding at Harvard

// ImageJ initialize
run("Colors...", "foreground=white background=black selection=magenta");
run("Options...", "iterations=1 count=1 black edm=Overwrite");
run("Set Measurements...", "area mean perimeter integrated area_fraction limit redirect=None decimal=5");

//set raw result folder. rawdir contains multiple subfolders, each subfolder contains multiple raw images
//each image is RGB format
//result and dendrites folders should be empty.
rawdir=getDirectory("Choose Raw Data Folder");
resultdir=getDirectory("Choose Result Folder");

//variable setup
var greenThreshold, redThreshold, blueThreshold, areapercent, scale, minsize, maxsize, name, precount, postcount, POIcount, prepostcount, postprecount;
var resultlist, FolderCreate, foldername, postprecount, prepostcount, totalpostprecount, totalprepostcount;
var UMcountpostprepostpost, UMcountprepostprepre, str, prepostRatio, postpostRatio, ratioTemp, prepostArray, prepreArray, postpreArray, postpostArray, colors;
var pre, post, POI, UMcountprePOIpostPOIPOIPOI, prePOIcount, postPOIcount, marker, second, third, mscount, xpre, xpost, xPOI, countArray;
var folderlist, rawdir, filelist, resultpath, totalprePOIcount, totalpostPOIcount, markersecondcount, markersecondArray, markerthirdcount, markerthirdArray;
var totalmarkersecondcount, totalmarkerthirdcount;

//three thresholds - specify which channel is for "pre-", post-, and protein of interest (POI)
//restrict the ROI of the "presynaptic" marker to the puncta associated with postsynaptic puncta
//get the intensity of the presynaptic marker within the protein of interest ROI
//and compare it to the overall intensity of the protein of interest within its own ROI?
//so, if you have G/R/B, with G=pre, R=post, B=POI, R associated G puncta used to assess the intensity of B signal
//within the G ROI and the intensity of the B signal within the B ROI.

// input parameter

colors = newArray("Green", "Red", "Blue");
parameterinput();

print("Raw_Folder:	"+rawdir);
print("Result_Folder:	"+resultdir);
print("GreenThreshold	RedThreshold	BlueThreshold	AreaPercent(%)	PixelScale(um/pixel)	Min_Puncta_Size	Max_Puncta_Size");
print(greenThreshold+"	"+redThreshold+"	"+blueThreshold+"	"+areapercent+"	"+scale+"	"+minsize+"	"+maxsize);
//mod this portion to display the ratio of counted to total GR/RG puncta
print(" 	"+pre+"Puncta#	"+post+"Puncta#	"+POI+"Puncta#	"+pre+post+"#	"+post+pre+"#	"+pre+POI+"#	"+post+POI+"#	"+POI+pre+"#	"+POI+post+"#	DendriteLength(um)	Density_"+pre+"(#/um)	Density_"+post+"(#/um)	Density_"+POI+"(#/um)	Density_"+pre+post+"(#/um)	Density_"+post+pre+"(#/um)	Density_"+pre+POI+"(#/um)	Density_"+post+POI+"(#/um)	Density_"+POI+pre+"(#/um)	Density_"+POI+post+"(#/um)		"+pre+post+"_totalCounted	"+post+pre+"_totalCounted	"+pre+POI+"_totalCounted	"+post+POI+"_totalCounted	"+POI+pre+"_totalCounted	"+POI+post+"_totalCounted");
// add 
folderlist=getFileList(rawdir);

//setup for the intensity analysis, overlay of ROI from mask on unmasked channel image
//prepost = pre ROI/post image
//prepre = pre ROI/pre image
//postpreArray = post ROI/pre image
//postpost = post ROI/post image
//prePOI = pre ROI/POI image
//postPOI = post ROI/POI image
//POIPOI = POI ROI/POI image
//prepostPOI = pre associated post ROI/POI image
//postprePOI = post associated pre ROI/POI image

//these arrays are for two channel associations
prepostArray = newArray("");
prepreArray = newArray("");
postpreArray = newArray(""); 
postpostArray = newArray("");
prePOIArray = newArray("");
postPOIArray = newArray("");
POIPOIArray = newArray("");


//these arrays are for two channel associations dependent on a third
prepostPOIArray = newArray("");
postprePOIArray = newArray("");

//prepostRatio = newArray("");
//postpostRatio = newArray("");

UMcountprepostprepre = " Filename	#	AreaOf"+pre+"ROI		PrePost%Overlap	PrePostmeanGrey	PrePostint_density(um)	PrePostraw_int_den(pix)		PrePre%Overlap	PrePremeanGrey	PrePreint_density(um)	PrePreraw_int_den(pix)\n";
UMcountpostprepostpost = "Filename	#	AreaOf"+post+"ROI		PostPre%Overlap	PostPremeanGrey	PostPreint_density(um)	PostPreraw_int_den(pix)		PostPost%Overlap	PostPostmeanGrey	PostPostint_density(um)	PostPostraw_int_den(pix)\n";
UMcountprePOIpostPOIPOIPOI = "Filename	#	AreaOf"+pre+"ROI		PrePOI%Overlap	PrePOImeanGrey	PrePOIint_density(um)	PrePOIraw_int_den(pix)		AreaOf"+post+"ROI	PostPOI%Overlap	PostPOImeanGrey	PostPOIint_density(um)	PostPOIraw_int_den(pix)		AreaOf"+POI+"ROI	POIPOI%Overlap	POIPOImeanGrey	POIPOIint_density(um)	POIPOIraw_int_den(pix)\n";
UMcounttriple = "Filename	#	AreaOf"+pre+post+"assocROI		PrePostPOIPOI%Overlap	PrePostPOIPOImeanGrey	PrePostPOIPOIint_density(um)	PrePostPOIraw_int_den(pix)		#	AreaOf"+post+pre+"assocROI	PostPrePOI%Overlap	PostPrePOImeanGrey	PostPrePOIint_density(um)	PostPrePOIraw_int_den(pix)\n";

//"foldercreate" is for generation of result folders - at the time of making this, it didn't allow for autoselection
//of the result folder with the code. Might be worth going back thru to see if it can be done a diff
//way that reduces the input I've gotta do

for(f=0;f<folderlist.length;f++) {
	foldername = File.getName(rawdir+folderlist[f]);
	File.makeDirectory(resultdir+foldername);
	rawlist=getFileList(rawdir+foldername);
	filelist=getFileList(rawdir+folderlist[f]);
	resultpath = getFileList(rawdir+folderlist[f]);
	print(folderlist[f]);

	prepostArray = Array.concat(prepostArray,folderlist[f]+"\n");
	prepreArray = Array.concat(prepreArray,"");
	postpreArray = Array.concat(postpreArray,folderlist[f]+"\n");
	postpostArray = Array.concat(postpostArray,"");
	prePOIArray = Array.concat(prePOIArray,folderlist[f]+"\n");
	postPOIArray = Array.concat(postPOIArray,"");
	POIPOIArray = Array.concat(POIPOIArray,"");

	prepostPOIArray = Array.concat(prepostPOIArray,folderlist[f]+"\n");
	postprePOIArray = Array.concat(postprePOIArray,"");

	for(d=0;d<filelist.length;d++) {
		//initialize :  open file, split channel, name by "red"/"green"/"blue"/"axon"
		initialize();

		//create green, red, blue mask images and roi files
		mask(pre); 
		mask(post);
		mask(POI);

		//this function opens the saved ROI files for the green, red, blue channels of each image and overlays them
		//either using the green mask as the base image and checking for overlap of the red puncta, etc...
		//because the puncta sizes differ, this can be pretty variable between G, R, B

		totalprepostcount = 0;
		totalpostprecount = 0;
		totalprePOIcount = 0;
		totalpostPOIcount = 0;
		totalPOIprecount = 0;
		totalPOIpostcount = 0;
		prepostcount = 0;
		postprecount = 0;
		prePOIcount = 0;
		postPOIcount = 0;
		POIprecount = 0;
		POIpostcount = 0;

		//measure
		
		//the function below was moved to be actual code because arrays don't populate within a fx in javascript/imagej language
		//in imagej because it's dumb.
		
		//prepost, prepre, prePOI

		roiManager("reset");
	  	if(File.exists(resultdir+folderlist[f]+name+"_"+pre+"_ROI.zip") ==1)	{
	  	  	roiManager("Open", resultdir+folderlist[f]+name+"_"+pre+"_ROI.zip");
	  		selectImage(post+" mask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		counted=0;
	  		x = 0;
	  		for(i=0;i<roiManager("Count");i++) {
	  			totalprepostcount = totalprepostcount + getResult("%Area",i);
	  			if(getResult("%Area",i) >= areapercent) {
	  				counted++;
	  			}
	  			x++;	
	  		}
	  		totalprepostcount = x;
	  		prepostcount = counted;
	  		selectImage(pre+" mask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		counted=0;
	  		x = 0;
	  		for(i=0;i<roiManager("Count");i++) {
	  			if(getResult("%Area",i) >= areapercent) {
	  				counted++;
	  			}
	  			x++;	
	  		}
	  		totalpreprecount = x;
	  		preprecount = counted;

	  		selectImage(POI+" mask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		counted=0;
	  		x = 0;
	  		for(i=0;i<roiManager("Count");i++) {
	  			if(getResult("%Area",i) >= areapercent) {
	  				counted++;
	  			}
	  			x++;	
	  		}
	  		totalprePOIcount = x;
	  		prePOIcount = counted;


	  		selectImage(post+"-unmask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		for(i=0;i<roiManager("Count");i++) {
	  			if(getResult("Area",i)>0){
	  				if(getResult("%Area",i)>0)	{
		 	  			//this str just stores the values from the ROI measure function to be put into the appropriate array for the green ROI
	 		  			str = filelist[d]+"	"+i+1+"	"+getResult("Area",i)+"		"+getResult("%Area",i)+"	"+ getResult("Mean",i)+"	"+getResult("IntDen",i)+"	"+getResult("RawIntDen",i);
	 	  				prepostArray = Array.concat(prepostArray,str);
	 	 			}
	 	 		}
	  		}
	  		selectImage(pre+"-unmask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		for(i=0;i<roiManager("Count");i++) {
	  			if(getResult("Area",i)>0){
	  				if(getResult("%Area",i)>0)	{
		  				str = "		"+getResult("%Area",i)+"	"+ getResult("Mean",i)+"	"+getResult("IntDen",i)+"	"+getResult("RawIntDen",i)+"\n";
		  				prepreArray = Array.concat(prepreArray,str);
	  				}
	  			}
	  		}
	  		selectImage(POI+"-unmask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		for(i=0;i<roiManager("Count");i++) {
	  			if(getResult("Area",i)>0){
	  				if(getResult("%Area",i)>0)	{
		  				str = filelist[d]+"	"+i+1+"	"+getResult("Area",i)+"		"+getResult("%Area",i)+"	"+ getResult("Mean",i)+"	"+getResult("IntDen",i)+"	"+getResult("RawIntDen",i);
		  				prePOIArray = Array.concat(prePOIArray,str);
	  				}
	  			}
	  		}
	  	}
		else{
			totalprepostcount = 0;
			prepostcount = 0;
			totalpreprecount = 0;
			preprecount = 0;
			totalprePOIcount = 0;
			prePOIcount = 0;
		}

		//postpre, postpost, postPOI

		roiManager("reset"); 
		run("Clear Results");
		//prints this + variable strings produced from the other functions to the log to be saved
		if(File.exists(resultdir+folderlist[f]+name+"_"+post+"_ROI.zip") ==1)	{
		  	roiManager("Open", resultdir+folderlist[f]+name+"_"+post+"_ROI.zip");
			selectImage(pre+" mask");
			run("Clear Results");
			roiManager("Measure");
			counted=0;
			x = 0;
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("%Area",i) >= areapercent) {
					counted++;
				}
				x++;	
			}
			totalpostprecount = x;
			postprecount = counted;
	
			selectImage(post+" mask");
			run("Clear Results");
			roiManager("Measure");
			counted=0;
			x = 0;
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("%Area",i) >= areapercent) {
					counted++;
				}
				x++;	
			}
			totalpostpostcount = x;
			postpostcount = counted;
	
			selectImage(POI+" mask");
			run("Clear Results");
			roiManager("Measure");
			counted=0;
			x = 0;
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("%Area",i) >= areapercent) {
					counted++;
				}
				x++;
			}
			totalpostPOIcount = x;
			postPOIcount = counted;
	
			selectImage(pre+"-unmask");
			run("Clear Results");
			roiManager("Measure");
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("Area",i)>0)	{
					if(getResult("%Area",i)>0)	{
						//this str just stores the values from the ROI measure function to be put into the appropriate array for the green ROI
						str = filelist[d]+"	"+i+1+"	"+getResult("Area",i)+"		"+getResult("%Area",i)+"	"+ getResult("Mean",i)+"	"+getResult("IntDen",i)+"	"+getResult("RawIntDen",i);
						postpreArray = Array.concat(postpreArray,str);
					}
				}
			}
	
			selectImage(post+"-unmask");
			run("Clear Results");
			roiManager("Measure");
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("Area",i)>0)	{
					if(getResult("%Area",i)>0)	{
						str = "		"+getResult("%Area",i)+"	"+ getResult("Mean",i)+"	"+getResult("IntDen",i)+"	"+getResult("RawIntDen",i)+"\n";
						postpostArray = Array.concat(postpostArray,str);
					}
				}
			}
	
			selectImage(POI+"-unmask");
			run("Clear Results");
			roiManager("Measure");
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("Area",i)>0)	{
					if(getResult("%Area",i)>0)	{
						str = "		"+getResult("Area",i)+"	"+getResult("%Area",i)+"	"+ getResult("Mean",i)+"	"+getResult("IntDen",i)+"	"+getResult("RawIntDen",i);
						postPOIArray = Array.concat(postPOIArray,str);
					}
				}
			}
		}
		else{
			totalpostprecount = 0;
			postprecount = 0;
			totalpostpostcount = 0;
			postpostcount = 0;
			totalpostPOIcount = 0;
			postPOIcount = 0;

		}
		//POIPOI prepostPOI postprePOI
		//prints this + variable strings produced from the other functions to the log to be saved

		roiManager("reset");
	  	if(File.exists(resultdir+folderlist[f]+name+"_"+POI+"_ROI.zip") ==1)	{
	  		roiManager("Open", resultdir+folderlist[f]+name+"_"+POI+"_ROI.zip");
  			
	  		selectImage(pre+" mask");
			run("Clear Results");
			roiManager("Measure");
			counted=0;
			x = 0;
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("%Area",i) >= areapercent) {
					counted++;
				}
				x++;	
			}
			totalPOIprecount = x;
			POIprecount = counted;
	
			selectImage(post+" mask");
			run("Clear Results");
			roiManager("Measure");
			counted=0;
			x = 0;
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("%Area",i) >= areapercent) {
					counted++;
				}
				x++;	
			}
			totalPOIpostcount = x;
			POIpostcount = counted;

  			selectImage(POI+" mask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		counted=0;
	  		x = 0;
	  		for(i=0;i<roiManager("Count");i++) {
	  			if(getResult("%Area",i) >= areapercent) {
	  				counted++;
	  			}
	  			x++;	
	  		}
	  		totalPOIPOIcount = x;
	  		POIPOIcount = counted;
	  	
  			selectImage(POI+"-unmask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		for(i=0;i<roiManager("Count");i++) {
	  			if(getResult("Area",i)>0)	{
	  				if(getResult("%Area",i)>0)	{
	  					str = "		"+getResult("Area",i)+"	"+getResult("%Area",i)+"	"+ getResult("Mean",i)+"	"+getResult("IntDen",i)+"	"+getResult("RawIntDen",i)+"\n";
	  					POIPOIArray = Array.concat(POIPOIArray,str);
	  				}
	  			}
	  		}
	  	}
	  	else{
			totalPOIPOIcount = 0;
			POIPOIcount = 0;
		}

		//this is measuring the number of pre ROI that associate with 
		//post ROI and overlaying that over the POI raw image
		//to get the intensity of the POI signal associated with 
		//these two other signals

		roiManager("reset");
		countArray = newArray();
		if(File.exists(resultdir+folderlist[f]+name+"_"+pre+"_ROI.zip") ==1)	{
	  		roiManager("Open", resultdir+folderlist[f]+name+"_"+pre+"_ROI.zip");
	  		selectImage(post+" mask");
	  		run("Clear Results");
	  		roiManager("Measure");
	  		for(i=0;i<roiManager("Count");i++) {
	  			if(getResult("%Area",i) >= areapercent) {
	  				countArray = Array.concat(countArray,i);
	  			}	
	  		}
	  		run("Clear Results");
	  		selectImage(POI+"-unmask");
	  		for(j=0;j<countArray.length;j++)	{
	  			roiManager("Select", countArray[j]);
	  			roiManager("Measure");
	  			str = filelist[d]+"	"+countArray[j]+1+"	"+getResult("Area",j)+"		"+getResult("%Area",j)+"	"+ getResult("Mean",j)+"	"+getResult("IntDen",j)+"	"+getResult("RawIntDen",j);
	  			prepostPOIArray = Array.concat(prepostPOIArray,str);
	  		}
	  	}

		roiManager("reset");
		countArray = newArray();
		if(File.exists(resultdir+folderlist[f]+name+"_"+post+"_ROI.zip") ==1)	{
		 	roiManager("Open", resultdir+folderlist[f]+name+"_"+post+"_ROI.zip");
			selectImage(pre+" mask");
			run("Clear Results");
			roiManager("Measure");
			for(i=0;i<roiManager("Count");i++) {
				if(getResult("%Area",i) >= areapercent) {
					countArray = Array.concat(countArray,i);
				}	
			}
			//ok, it's saying that the selected ROI is out of the range of the number of ROI
			//but that shouldn't be possible given that they are both referencing the same thing???
			run("Clear Results");
			selectImage(POI+"-unmask");
			for(j=0;j<countArray.length;j++)	{
				roiManager("Select", countArray[j]);
				roiManager("Measure");
				str = "		"+countArray[j]+1+"		"+getResult("Area",j)+"	"+getResult("%Area",j)+"	"+ getResult("Mean",j)+"	"+getResult("IntDen",j)+"	"+getResult("RawIntDen",j)+"\n";
				postprePOIArray = Array.concat(postprePOIArray,str);
			}
		}

		run("Close All"); 
		print(name+"	"+precount+"	"+postcount+"	"+POIcount+"	"+prepostcount+"	"+postprecount+"	"+prePOIcount+"	"+postPOIcount+"	"+POIprecount+"	"+POIpostcount+"	ROIlength	"+precount+"/length	"+postcount+"/length	"+prepostcount+"/length	"+postprecount+"/length	"+prePOIcount+"/length	"+postPOIcount+"/length	"+POIprecount+"/length	"+POIpostcount+"/length		"+totalprepostcount+"	"+totalpostprecount+"	"+totalprePOIcount+"	"+totalpostPOIcount+"	"+totalPOIprecount+"	"+totalPOIpostcount);
		//resultdir+folderlist[f] is the name of the condition
		temptitle = File.getName(resultdir+folderlist[f]);
	}
}

//correcting the length on the differentially sized arrays so they can be displayed properly on the
//the excel sheet and don't break the macro

//these take the strings and the log and save them as tab separated excel sheets

selectWindow("Log");
saveAs("Text", resultdir+"Summary.xls");
selectWindow("Log"); 
run("Close");
selectWindow("Results"); 
run("Close");
selectWindow("ROI Manager"); 
run("Close");

UMcountprepostprepre = UMcountprepostprepre +"				"+ pre+"ROI/"+post+"Img					"+ pre+"ROI/"+ pre+"Img\n";
for(k=0;k<prepostArray.length;k++)	{
	UMcountprepostprepre = UMcountprepostprepre + prepostArray[k] +prepreArray[k];
}

UMcountpostprepostpost = UMcountpostprepostpost+"				"+ post+"ROI/"+pre+"Img					"+ post+"ROI/"+ post+"Img\n";
for(k=0;k<postpreArray.length;k++)	{
	UMcountpostprepostpost = UMcountpostprepostpost + postpreArray[k] +postpostArray[k];
}

UMcountprePOIpostPOIPOIPOI = UMcountprePOIpostPOIPOIPOI+"				"+ pre+"ROI/"+POI+"Img					"+post+"ROI/"+POI+"Img						"+POI+"ROI/"+POI+"Img"+" \n";
for(k=0;k<prePOIArray.length;k++)	{
	if(prePOIArray.length>k){
		prePOI = prePOIArray[k];
	}
	else{
		prePOI = "";
	}
	if(postPOIArray.length>k){
		postPOI = postPOIArray[k];
	}
	else{
		postPOI = "";
	}
	if(POIPOIArray.length>k){
		POIPOI = POIPOIArray[k];
	}
	else{
		POIPOI = "\n";
	}
	UMcountprePOIpostPOIPOIPOI = UMcountprePOIpostPOIPOIPOI + prePOI+postPOI+POIPOI;
}

UMcounttriple = UMcounttriple+"				"+ pre+post+"ROI/"+POI+"Img					"+pre+post+"ROI/"+POI+"Img\n";
for(k=0;k<prepostPOIArray.length;k++)	{
	if(prepostPOIArray.length>k){
		prepostPOI = prepostPOIArray[k];
	}
	else{
		prepostPOI = "";
	}
	if(postprePOIArray.length>k){
		postprePOI = postprePOIArray[k];
	}
	else{
		postprePOI = "\n";
	}
	UMcounttriple = UMcounttriple + prepostPOI +postprePOI;
}



File.saveString(UMcountprepostprepre,resultdir+"rawPrePostintensity.xls");
File.saveString(UMcountpostprepostpost,resultdir+"rawPostPreintensity.xls");
File.saveString(UMcountprePOIpostPOIPOIPOI,resultdir+"rawprepostPOIintensity.xls");
File.saveString(UMcounttriple,resultdir+"rawPOItripleintensity.xls");

//the following functions are listed in order of use in the macro

//thresholding parameters are generally the only ones that need changing, but all can be modified
function parameterinput()
	{
	Dialog.create("Parameter");
		Dialog.addNumber("Green Threshold:", 30);
		Dialog.addNumber("Red Threshold:", 30);
		Dialog.addNumber("Blue Threshold", 30);
		Dialog.addNumber("Area Percent (%):", 25);
		Dialog.addNumber("Pixel Scale (um/pixel):", 0.1705);
		Dialog.addNumber("Min Puncta Size (pixel):", 1);
		Dialog.addNumber("Max Puncta Size (pixel):", 60);
		Dialog.addChoice("presynaptic nchannel",colors,colors[0]);
		Dialog.addChoice("postsynaptic channel",colors,colors[1]);
		Dialog.addChoice("associated protein of interest",colors,colors[2]);
	Dialog.show();
	greenThreshold = Dialog.getNumber();
	redThreshold = Dialog.getNumber();
	blueThreshold = Dialog.getNumber();
	areapercent = Dialog.getNumber();  
	scale = Dialog.getNumber();  
	minsize = Dialog.getNumber();  
	maxsize = Dialog.getNumber(); 
	pre = Dialog.getChoice();
	post = Dialog.getChoice();
	POI = Dialog.getChoice();
	}
	
//this function opens the appropriate image from the appropriate folder in the raw data folder
//gets the name, standardizes the properties of the image, splits the channels and discards the blue channel 
//as "axon" to be saved elsewhere

function initialize()
 {
	open(rawdir+foldername+File.separator+rawlist[d]);
	name=getInfo("image.filename");
	run("Properties...", "channels=1 slices=1 frames=1 unit=um pixel_width="+scale+" pixel_height=0.1705 voxel_depth=1");
	run("Split Channels");

	selectImage(name+" (blue)"); 
	rename("Blue");
	run("Duplicate...", " ");
	selectImage("Blue-1"); 
	rename("Blue-unmask");

	selectImage(name+" (green)"); 
	rename("Green");
	run("Duplicate...", " ");
	selectImage("Green-1"); 
	rename("Green-unmask");

	selectImage(name+" (red)"); 
	rename("Red");
	run("Duplicate...", " ");
	selectImage("Red-1"); 
	rename("Red-unmask");
 }

//this function creates a mask for the selected color channel (green or red). 
//it takes the threshold indicated in the parameter input, uses it to point out the maxima 
//and then runs "analyze particles" within the specified puncta size, saves the number of puncta as a string, saves the ROI, 
//and saves the mask

function mask(channel)
	{
	selectImage(channel);
	run("Gaussian Blur...", "sigma=1");
	if( channel == "Green") {
		setThreshold(greenThreshold, 255);
		}
	if( channel == "Red") {
		setThreshold(redThreshold, 255);
		}
	if( channel == "Blue") {
		setThreshold(blueThreshold, 255);
		}
	run("Find Maxima...", "noise=10 output=[Segmented Particles] above");
	run("Analyze Particles...", "size="+minsize+"-"+maxsize+" pixel show=Masks add");
	selectWindow("Mask of "+channel+" Segmented");  
	run("Grays");
	saveAs("Tiff", resultdir+folderlist[f]+name+"_"+channel+"_mask.tif");
	run("Clear Results");
	roiManager("Measure");
	selectWindow("Results");

	run("Clear Results");
	rename(channel+" mask");
	selectImage(channel); 
	close();
	selectImage(channel+" Segmented"); 
	close();

	//gets the # of puncta counted in each condition
	if( channel == pre )  {
		precount = roiManager("Count");
		}
	if( channel == post )  {
		postcount = roiManager("Count");
		}
	if( channel == POI )  {
		POIcount = roiManager("Count");
		}
  
	if( roiManager("Count") > 0 )
		{
		roiManager("Save",resultdir+folderlist[f]+name+"_"+channel+"_ROI.zip");
		}
	roiManager("reset");
	}

//this function increases the contrast for the blue channel (marking dendrites even though it says axons)
//and measures the length of the segment (even though this is usually also done manually as a precaution)
